class DictionaryModule {
    constructor(app) {
        this.app = app;
        this.dictionary = this.createDictionary();
    }
    
    init() {
        console.log('ğŸ“š Dictionary Module Initialized');
        this.setupEventListeners();
        this.updateStats();
        this.loadSampleWords();
    }
    
    // Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù„ØºØ§Øª
    createDictionary() {
        return {
            'hello': {
                word: 'hello',
                persian: 'Ø³Ù„Ø§Ù…',
                english: 'a greeting when you meet someone',
                examples: ['Hello, how are you?', 'She said hello to everyone.'],
                collocations: ['say hello', 'hello there', 'hello everyone'],
                phrases: [{ phrase: 'Hello there!', meaning: 'Ø³Ù„Ø§Ù…! (Ø±Ø³Ù…ÛŒâ€ŒØªØ±)', example: 'Hello there! How have you been?' }],
                level: 'A1'
            },
            'good': {
                word: 'good',
                persian: 'Ø®ÙˆØ¨',
                english: 'of a high quality or standard',
                examples: ['This is good food.', 'He is a good teacher.'],
                collocations: ['good morning', 'good idea', 'good job', 'good friend'],
                phrases: [{ phrase: 'good for you', meaning: 'Ø¢ÙØ±ÛŒÙ†', example: 'You passed the exam? Good for you!' }],
                level: 'A1'
            },
            'go': {
                word: 'go',
                persian: 'Ø±ÙØªÙ†',
                english: 'to move or travel to a place',
                examples: ['I go to school every day.', 'Let\'s go to the park.'],
                collocations: ['go home', 'go to school', 'go shopping', 'go crazy'],
                phrasalVerbs: [
                    { verb: 'go on', meaning: 'Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø¯Ù†', example: 'Please go on with your story.' },
                    { verb: 'go out', meaning: 'Ø¨ÛŒØ±ÙˆÙ† Ø±ÙØªÙ†', example: 'We go out every Friday.' }
                ],
                phrases: [
                    { phrase: 'go ahead', meaning: 'Ø¨Ø±Ùˆ Ø¬Ù„Ùˆ', example: 'Can I use your phone? Go ahead!' },
                    { phrase: 'go away', meaning: 'Ø¨Ø±Ùˆ', example: 'Go away and leave me alone.' }
                ],
                level: 'A1'
            }
            // ... Ù„ØºØ§Øª Ø¨ÛŒØ´ØªØ±
        };
    }
    
    setupEventListeners() {
        // Ø¬Ø³ØªØ¬Ùˆ
        const searchBtn = document.getElementById('searchBtn');
        const wordInput = document.getElementById('wordInput');
        
        if (searchBtn && wordInput) {
            searchBtn.addEventListener('click', () => this.searchWord());
            
            wordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.searchWord();
                }
            });
        }
        
        // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø³Ø±ÛŒØ¹
        document.querySelectorAll('.suggestion-tag').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const word = e.currentTarget.dataset.word;
                wordInput.value = word;
                this.searchWord();
            });
        });
    }
    
    async searchWord() {
        const input = document.getElementById('wordInput');
        const word = input.value.trim().toLowerCase();
        
        if (!word) {
            this.app.modules.ui.showNotification('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù„ØºØª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
            input.focus();
            return;
        }
        
        this.showLoadingState('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...');
        
        try {
            let result = this.dictionary[word];
            
            if (!result) {
                for (const key in this.dictionary) {
                    if (key.startsWith(word) || word.startsWith(key)) {
                        result = {
                            original: word,
                            found: this.dictionary[key],
                            message: 'Ø¢ÛŒØ§ Ù…Ù†Ø¸ÙˆØ± Ø´Ù…Ø§ Ø§ÛŒÙ† Ø§Ø³ØªØŸ'
                        };
                        break;
                    }
                }
            }
            
            if (!result) {
                this.showNoResults(word);
                return;
            }
            
            this.displayWordResult(result);
            
            if (this.app.soundEnabled) {
                this.speakWord(result.word || result.found?.word || word);
            }
            
            if (document.getElementById('autoSave')?.checked) {
                this.app.modules.leitner.addWord(result);
            }
            
            this.app.userData.wordsLearned++;
            this.app.saveUserData();
            this.updateStats();
            
            this.app.modules.ui.showNotification(`Ù„ØºØª "${word}" Ù¾ÛŒØ¯Ø§ Ø´Ø¯!`, 'success');
            
        } catch (error) {
            console.error('Search error:', error);
            this.app.modules.ui.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯', 'error');
        }
    }
    
    speakWord(word) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.rate = 0.7;
            speechSynthesis.speak(utterance);
        }
    }
    
    showLoadingState(message) {
        const resultsArea = document.getElementById('resultsArea');
        if (!resultsArea) return;
        
        resultsArea.innerHTML = `
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>${message}</p>
            </div>
        `;
    }
    
    displayWordResult(wordData) {
        const resultsArea = document.getElementById('resultsArea');
        if (!resultsArea) return;
        
        if (wordData.found) {
            const suggestion = wordData.found;
            resultsArea.innerHTML = `
                <div class="suggestions-container">
                    <h3>${wordData.message}</h3>
                    <div class="suggestion-item" onclick="app.modules.dictionary.searchWordDirect('${suggestion.word}')">
                        <strong>${suggestion.word}</strong>
                        <span>${suggestion.persian}</span>
                        <i class="fas fa-arrow-left"></i>
                    </div>
                </div>
            `;
            return;
        }
        
        // ... Ú©Ø¯ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ Ù„ØºØª
        const word = wordData.word;
        const persian = wordData.persian;
        const english = wordData.english;
        
        resultsArea.innerHTML = `
            <div class="word-card">
                <div class="word-header">
                    <h2>${word}</h2>
                    <button class="play-btn" onclick="app.modules.dictionary.speakWord('${word}')">
                        <i class="fas fa-volume-up"></i> Ù¾Ø®Ø´ ØµÙˆØª
                    </button>
                </div>
                
                <div class="word-info">
                    <div class="meaning">
                        <strong>ÙØ§Ø±Ø³ÛŒ:</strong> ${persian}
                    </div>
                    <div class="meaning">
                        <strong>ØªØ¹Ø±ÛŒÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ:</strong> ${english}
                    </div>
                </div>
                
                <div class="word-footer">
                    <span class="level">Ø³Ø·Ø­: ${wordData.level || 'A1'}</span>
                    <button class="save-btn" onclick="app.modules.leitner.addWord(app.modules.dictionary.getCurrentWord())">
                        <i class="far fa-star"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù„Ø§ÛŒØªÙ†Ø±
                    </button>
                </div>
            </div>
        `;
    }
    
    searchWordDirect(word) {
        document.getElementById('wordInput').value = word;
        this.searchWord();
    }
    
    getCurrentWord() {
        const input = document.getElementById('wordInput');
        return input ? input.value.trim() : '';
    }
    
    showNoResults(word) {
        const resultsArea = document.getElementById('resultsArea');
        if (!resultsArea) return;
        
        resultsArea.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>Ù„ØºØª "${word}" ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                <p>Ø§ÛŒÙ† Ù„ØºØ§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ø³ØªÙ†Ø¯:</p>
                <div class="suggestions">
                    <button onclick="app.modules.dictionary.searchWordDirect('hello')">hello</button>
                    <button onclick="app.modules.dictionary.searchWordDirect('good')">good</button>
                    <button onclick="app.modules.dictionary.searchWordDirect('go')">go</button>
                </div>
            </div>
        `;
    }
    
    updateStats() {
        const countElement = document.getElementById('wordCount');
        if (countElement) {
            countElement.textContent = Object.keys(this.dictionary).length + '+';
        }
    }
    
    loadSampleWords() {
        const suggestionsContainer = document.querySelector('.suggestions');
        if (suggestionsContainer && suggestionsContainer.children.length === 0) {
            const sampleWords = ['hello', 'good', 'go', 'have', 'time'];
            
            sampleWords.forEach(word => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-tag';
                btn.dataset.word = word;
                btn.textContent = word;
                btn.addEventListener('click', (e) => {
                    const word = e.currentTarget.dataset.word;
                    document.getElementById('wordInput').value = word;
                    this.searchWord();
                });
                suggestionsContainer.appendChild(btn);
            });
        }
    }
}
