<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred Practice Elite</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { 
            --bg: #e0e5ec; --accent: #1e40af; --main-word: #000000; --text: #444; 
            --shadow: 9px 9px 16px rgb(163,177,198,0.5), -9px -9px 16px rgba(255,255,255, 0.6); 
            --inner-shadow: inset 5px 5px 10px #b8bec5, inset -5px -5px 10px #ffffff;
        }
        body.dark { 
            --bg: #2d3436; --accent: #3b82f6; --main-word: #ffffff; --text: #ccc; 
            --shadow: 5px 5px 10px #23282a, -5px -5px 10px #374042;
            --inner-shadow: inset 4px 4px 8px #23282a, inset -4px -4px 8px #374042;
        }
        body { background: var(--bg); font-family: Tahoma, sans-serif; transition: 0.3s; padding: 20px; margin: 0; color: var(--text); touch-action: manipulation; }
        .neu-card { background: var(--bg); border-radius: 20px; box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; text-align: center; }
        .neu-btn { border: none; background: var(--bg); box-shadow: var(--shadow); padding: 15px 20px; border-radius: 15px; cursor: pointer; color: var(--accent); transition: 0.2s; font-size: 1em; font-family: Tahoma; }
        .neu-btn:active { transform: scale(0.95); box-shadow: var(--inner-shadow); }
        .search-input { width: 100%; border: none; background: var(--bg); box-shadow: var(--inner-shadow); padding: 18px; border-radius: 20px; outline: none; color: var(--accent); text-align: center; box-sizing: border-box; margin-bottom: 15px; font-size: 1.1em; }
        .hidden { display: none !important; }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 15px; font-size: 0.95em; animation: fadeIn 0.3s; line-height: 1.6; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar { width: 100%; height: 10px; background: var(--bg); border-radius: 10px; box-shadow: var(--inner-shadow); margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s; }
        .header-box { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 25px; }
    </style>
</head>
<body class="light">

    <div class="neu-card header-box">
        <div style="font-size: 1.1em;">â­ <span id="starDisp">0</span></div>
        <button class="neu-btn" style="padding: 10px 15px; border-radius: 50%;" onclick="app.toggleTheme()">ğŸŒ“</button>
        <div style="font-size: 1.1em;">Score: <span id="scoreDisp">0</span></div>
    </div>

    <div id="authArea" class="neu-card">
        <h2 style="font-weight:normal;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Fred Elite</h2>
        <input type="text" id="studentName" class="search-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <input type="text" id="vipCode" class="search-input" placeholder="Ú©Ø¯ ÙˆØ±ÙˆØ¯">
        <button class="neu-btn" style="width:100%;" onclick="app.manualLogin()">ÙˆØ±ÙˆØ¯</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="neu-card">
            <input type="text" id="wordInput" class="search-input" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„ØºØ§Øª..." oninput="app.liveSearch()">
            <div id="results"></div>
        </div>
        <div id="quizContainer">
            <div class="neu-card">
                <h2 style="font-weight:normal; color:var(--accent);">Fred Practice</h2>
                <p>Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Û±Û° Ø³ÙˆØ§Ù„ ØªØµØ§Ø¯ÙÛŒ Ù‡Ø³ØªÛŒØ¯ØŸ</p>
                <button class="neu-btn" style="width: 100%;" onclick="app.startSession()">Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†</button>
            </div>
        </div>
    </div>

    <script src="dictionary.js"></script>
    <script>
        class DicDeepApp {
            constructor() {
                this.score = 0; this.theme = 'light';
                this.isVIP = false; this.studentName = "";
                this.currentQIndex = 0; this.mistakes = []; this.clickCount = 0;
                // --- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ§Ø¯ ---
                this.blacklist = ["BadUser", "Test1"]; 
                // -----------------------
                this.initDaily();
                window.app = this;
                this.checkUrlParams(); 
            }

            initDaily() {
                const today = new Date().toDateString();
                let saved = JSON.parse(localStorage.getItem('fred_stats')) || { date: today, count: 0 };
                this.stats = (saved.date !== today) ? { date: today, count: 0 } : saved;
            }

            checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const urlName = params.get('name');
                const urlVip = params.get('vip');
                const savedName = localStorage.getItem('registered_name');

                if (urlName) {
                    if (this.blacklist.includes(urlName)) { alert("Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª."); return; }
                    
                    if (savedName && savedName !== urlName) {
                        alert("Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§ Ù†ÛŒØ³Øª. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…ÛŒÙ‡Ù…Ø§Ù†...");
                        this.studentName = "Guest_" + urlName;
                    } else {
                        localStorage.setItem('registered_name', urlName);
                        this.studentName = urlName;
                        if (urlVip === 'yes') this.isVIP = true;
                    }
                    this.autoLogin();
                }
            }

            autoLogin() {
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                this.sendLog(`ğŸš€ ÙˆØ±ÙˆØ¯ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©: ${this.studentName} | VIP: ${this.isVIP}`);
            }

            manualLogin() {
                const name = document.getElementById('studentName').value.trim();
                const code = document.getElementById('vipCode').value.trim().toUpperCase();
                if (!name) return;
                this.studentName = name;
                if (code === "FRED-2025") this.isVIP = true;
                this.autoLogin();
            }

            trackClick() {
                if (this.isVIP) return true;
                this.clickCount++;
                if (this.clickCount > 15) { alert("Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÛŒÙ‡Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯."); return false; }
                return true;
            }

            startSession() {
                if (!this.isVIP && this.stats.count >= 2) { alert("Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Û² Ø¨Ø§Ø± ØªÙ…Ø±ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯."); return; }
                this.currentQIndex = 0; this.mistakes = []; this.score = 0;
                this.nextQuestion();
            }

            generateQuestion() {
                const data = dictionary;
                const correct = data[Math.floor(Math.random() * data.length)];
                let wrongs = data.filter(i => i.en !== correct.en).sort(() => 0.5 - Math.random()).slice(0, 3);
                let opts = [correct, ...wrongs].sort(() => 0.5 - Math.random());
                return {
                    q: correct.ex.replace(new RegExp(correct.en, 'gi'), "_______"),
                    en: correct.en,
                    options: opts.map(o => o.fa),
                    correct: opts.indexOf(correct),
                    rationale: opts.map(o => o.en === correct.en ? "âœ… Ø¯Ø±Ø³Øª!" : `âŒ ØºÙ„Ø·! Ø§ÛŒÙ† Ù…Ø¹Ù†ÛŒ "${o.en}" Ø§Ø³Øª.`),
                    hint: `Ù…Ø¹Ù†ÛŒ: ${correct.fa}`
                };
            }

            nextQuestion() {
                if (this.currentQIndex >= 10) { this.finishSession(); return; }
                this.currentQIndex++;
                this.currentQData = this.generateQuestion();
                this.renderQuiz();
            }

            renderQuiz() {
                const item = this.currentQData;
                document.getElementById('quizContainer').innerHTML = `
                    <div class="neu-card">
                        <div class="progress-bar"><div class="progress-fill" style="width:${this.currentQIndex*10}%"></div></div>
                        <p style="direction:ltr; text-align:left; font-size:1.1em; line-height:1.7;">${item.q}</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:20px;">
                            ${item.options.map((opt, i) => `<button class="neu-btn" onclick="app.checkAns(${i})">${opt}</button>`).join('')}
                        </div>
                        <div id="fb" class="hidden feedback"></div>
                        <button id="nextBtn" class="neu-btn hidden" style="width:100%; margin-top:20px; background:var(--accent); color:white;" onclick="app.nextQuestion()">Ø¨Ø¹Ø¯ÛŒ â¯</button>
                    </div>`;
            }

            checkAns(choice) {
                if (!this.trackClick()) return;
                const item = this.currentQData;
                const fb = document.getElementById('fb'); fb.classList.remove('hidden');
                const correct = choice === item.correct;
                fb.innerText = item.rationale[choice]; fb.style.color = correct ? "green" : "red";
                if (correct) { this.score += 20; document.getElementById('scoreDisp').innerText = this.score; }
                else { this.mistakes.push({w: item.en, y: item.options[choice], c: item.options[item.correct]}); }
                document.querySelectorAll('#quizContainer button').forEach(b => { if(b.id !== 'nextBtn') b.onclick = null; });
                document.getElementById('nextBtn').classList.remove('hidden');
            }

            async finishSession() {
                this.stats.count++;
                localStorage.setItem('fred_stats', JSON.stringify(this.stats));
                let report = `ğŸ“Š Ù†Ù…Ø±Ù‡ ${this.studentName}: ${this.score}\n`;
                if (this.mistakes.length > 0) {
                    report += "âŒ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª:\n";
                    this.mistakes.forEach(m => report += `- ${m.w} (Ø²Ø¯: ${m.y})\n`);
                } else report += "â­ Ø¨Ø¯ÙˆÙ† ØºÙ„Ø·!";
                await this.sendLog(report);
                document.getElementById('quizContainer').innerHTML = `<div class="neu-card"><h3>Ù¾Ø§ÛŒØ§Ù†</h3><p>Ø§Ù…ØªÛŒØ§Ø²: ${this.score}</p><button class="neu-btn" onclick="location.reload()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>`;
            }

            async sendLog(msg) {
                const url = `https://api.telegram.org/bot553224514:AAG0XXzA8da55jCGXnzStP-0IxHhnfkTPRw/sendMessage?chat_id=969918598&text=${encodeURIComponent(msg)}`;
                try { await fetch(url); } catch(e) {}
            }

            toggleTheme() { this.theme = this.theme === 'light' ? 'dark' : 'light'; document.body.className = this.theme; }
            speak(t) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(t)); }
            liveSearch() {
                if (!this.trackClick()) return;
                const term = document.getElementById('wordInput').value.toLowerCase();
                const res = document.getElementById('results'); res.innerHTML = "";
                if(!term) return;
                dictionary.filter(w => w.en.toLowerCase().includes(term) || w.fa.includes(term)).slice(0,3).forEach(w => {
                    res.innerHTML += `<div class="neu-card" style="box-shadow:none; border:1px solid rgba(0,0,0,0.1); text-align:right; padding:15px;">
                        <div onclick="app.speak('${w.en}')" style="cursor:pointer;">${w.en} ğŸ”Š</div>
                        <div style="font-size:0.85em; color:var(--accent);">${w.fa}</div></div>`;
                });
            }
        }
        const app = new DicDeepApp();
    </script>
</body>
</html>
