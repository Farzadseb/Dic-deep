<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fred Practice Elite</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { 
            --bg: #e0e5ec; --accent: #1e40af; --main-word: #000000; --text: #444; 
            --shadow: 9px 9px 16px rgb(163,177,198,0.5), -9px -9px 16px rgba(255,255,255, 0.6); 
            --inner-shadow: inset 5px 5px 10px #b8bec5, inset -5px -5px 10px #ffffff;
        }
        body.dark { 
            --bg: #2d3436; --accent: #3b82f6; --main-word: #ffffff; --text: #ccc; 
            --shadow: 5px 5px 10px #23282a, -5px -5px 10px #374042;
            --inner-shadow: inset 4px 4px 8px #23282a, inset -4px -4px 8px #374042;
        }
        body { background: var(--bg); font-family: Tahoma, sans-serif; transition: 0.3s; padding: 20px; margin: 0; color: var(--text); touch-action: manipulation; }
        .neu-card { background: var(--bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; text-align: center; }
        .neu-btn { border: none; background: var(--bg); box-shadow: var(--shadow); padding: 12px 18px; border-radius: 12px; cursor: pointer; color: var(--accent); transition: 0.2s; font-weight: normal; font-family: Tahoma; }
        .neu-btn:active { transform: scale(0.97); box-shadow: var(--inner-shadow); }
        .neu-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .search-input { width: 100%; border: none; background: var(--bg); box-shadow: var(--inner-shadow); padding: 15px; border-radius: 15px; outline: none; color: var(--accent); text-align: center; box-sizing: border-box; margin-bottom: 10px; }
        .main-word-style { color: var(--main-word); font-size: 1.2em; font-weight: normal; direction: ltr; display: inline-block; }
        .example-box { font-size: 0.85em; background: rgba(0,0,0,0.02); padding: 12px; border-radius: 12px; margin-top: 12px; text-align: left; direction: ltr; border-left: 2px solid var(--accent); }
        .hidden { display: none !important; }
        .feedback { margin-top: 15px; padding: 10px; border-radius: 10px; font-size: 0.9em; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .progress-bar { width: 100%; height: 8px; background: var(--bg); border-radius: 10px; box-shadow: var(--inner-shadow); margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.3s; }
    </style>
</head>
<body class="light">

    <div class="neu-card">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div>Score: <span id="scoreDisp">0</span></div>
            <button class="neu-btn" onclick="app.toggleTheme()">ğŸŒ“</button>
            <div>â­ <span id="starDisp">0</span></div>
        </div>
    </div>

    <div id="authArea" class="neu-card">
        <h3 style="font-weight:normal;">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h3>
        <input type="text" id="studentName" class="search-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        <input type="text" id="vipCode" class="search-input" placeholder="Ú©Ø¯ VIP (Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ†)">
        <button class="neu-btn" style="width:100%; margin-top:10px;" onclick="app.login()">Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
    </div>

    <div id="mainApp" class="hidden">
        <div class="neu-card">
            <input type="text" id="wordInput" class="search-input" placeholder="ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„ØºØ§Øª..." oninput="app.liveSearch()">
            <div id="results"></div>
        </div>

        <div id="fredSection">
            <div id="quizContainer">
                <div class="neu-card">
                    <h2 style="font-weight:normal; color:var(--accent);">Fred Practice</h2>
                    <p>Ù‡Ø± Ù†ÙˆØ¨Øª Ø´Ø§Ù…Ù„ Û±Û° Ø³ÙˆØ§Ù„ ØªØµØ§Ø¯ÙÛŒ Ø§Ø² Ù…Ø®Ø²Ù† Ù„ØºØ§Øª Ø´Ù…Ø§Ø³Øª.</p>
                    <button class="neu-btn" onclick="app.startSession()">Ø´Ø±ÙˆØ¹ Ù†ÙˆØ¨Øª ØªÙ…Ø±ÛŒÙ†</button>
                </div>
            </div>
        </div>
    </div>

    <script src="dictionary.js"></script>
    <script>
        class DicDeepApp {
            constructor() {
                this.score = 0; this.theme = 'light';
                this.clickCount = 0; this.isVIP = false; this.studentName = "Ù…ÛŒÙ‡Ù…Ø§Ù†";
                this.currentQIndex = 0; this.mistakes = []; this.currentQData = null;
                this.dailyLimit = 2;
                this.fallbackDict = [{ en: "usually", fa: "Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹", ex: "I usually go home at 5.", col: "as usually", phr: "---" }];
                this.initDailyStats();
                window.app = this;
            }

            initDailyStats() {
                const today = new Date().toDateString();
                this.stats = JSON.parse(localStorage.getItem('fred_stats')) || { date: today, count: 0 };
                if (this.stats.date !== today) { this.stats = { date: today, count: 0 }; this.saveStats(); }
            }
            saveStats() { localStorage.setItem('fred_stats', JSON.stringify(this.stats)); }

            toggleTheme() { this.theme = this.theme === 'light' ? 'dark' : 'light'; document.body.className = this.theme; }

            login() {
                const name = document.getElementById('studentName').value.trim();
                const code = document.getElementById('vipCode').value.trim().toUpperCase();
                if (!name) { alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
                this.studentName = name;
                if (code === "FRED-2025") this.isVIP = true;
                document.getElementById('authArea').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                this.sendLog(`ğŸ‘¤ ÙˆØ±ÙˆØ¯ Ø¬Ø¯ÛŒØ¯: ${this.studentName} | ÙˆØ¶Ø¹ÛŒØª: ${this.isVIP?'VIP':'Guest'}`);
            }

            trackClick() {
                if (this.isVIP) return true;
                this.clickCount++;
                if (this.clickCount > 15) { // Ûµ Ú©Ù„ÛŒÚ© Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ + Û±Û° Ø³ÙˆØ§Ù„ Ú©ÙˆÛŒÛŒØ²
                    alert("Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…ÛŒÙ‡Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ VIP ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯.");
                    return false;
                }
                return true;
            }

            liveSearch() {
                if (!this.trackClick()) return;
                const term = document.getElementById('wordInput').value.toLowerCase().trim();
                const res = document.getElementById('results'); res.innerHTML = "";
                if(!term) return;
                const data = (typeof dictionary !== 'undefined') ? dictionary : this.fallbackDict;
                data.filter(w => w.en.toLowerCase().includes(term) || w.fa.includes(term)).slice(0,3).forEach(w => {
                    res.innerHTML += `
                    <div class="neu-card" style="box-shadow:none; border:1px solid rgba(0,0,0,0.05); text-align:right;">
                        <div onclick="app.speak('${w.en}')" style="cursor:pointer;"><span class="main-word-style">${w.en}</span> ğŸ”Š</div>
                        <div style="font-size:0.9em; margin-top:5px;">Ù…Ø¹Ù†ÛŒ: ${w.fa}</div>
                        <div class="example-box">${w.ex}</div>
                    </div>`;
                });
            }

            speak(text) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'en-US'; msg.rate = 0.8;
                window.speechSynthesis.speak(msg);
            }

            startSession() {
                if (!this.isVIP && this.stats.count >= this.dailyLimit) {
                    alert("Ø´Ù…Ø§ Û² Ø¨Ø§Ø± Ø¯Ø± Ø±ÙˆØ² ØªÙ…Ø±ÛŒÙ† Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ VIP Ù„Ø§Ø²Ù… Ø§Ø³Øª.");
                    return;
                }
                this.currentQIndex = 0; this.mistakes = []; this.score = 0;
                document.getElementById('scoreDisp').innerText = "0";
                this.nextQuestion();
            }

            nextQuestion() {
                if (this.currentQIndex >= 10) { this.finishSession(); return; }
                this.currentQIndex++;
                this.currentQData = this.generateQuestion();
                this.renderFredQ();
            }

            generateQuestion() {
                const data = (typeof dictionary !== 'undefined') ? dictionary : this.fallbackDict;
                const correct = data[Math.floor(Math.random() * data.length)];
                let wrongs = data.filter(i => i.en !== correct.en).sort(() => 0.5 - Math.random()).slice(0, 3);
                let opts = [correct, ...wrongs].sort(() => 0.5 - Math.random());
                return {
                    q: correct.ex.replace(new RegExp(correct.en, 'gi'), "_______"),
                    en: correct.en,
                    options: opts.map(o => o.fa),
                    correct: opts.indexOf(correct),
                    rationale: opts.map(o => o.en === correct.en ? "Ø¯Ø±Ø³Øª!" : `ØºÙ„Ø·! Ø§ÛŒÙ† Ù…Ø¹Ù†ÛŒ Ù„ØºØª "${o.en}" Ø§Ø³Øª.`),
                    hint: `Ù…Ø¹Ù†ÛŒ Ù„ØºØª: ${correct.fa}`
                };
            }

            renderFredQ() {
                const item = this.currentQData;
                document.getElementById('quizContainer').innerHTML = `
                    <div class="neu-card" style="box-shadow:none;">
                        <div class="progress-bar"><div class="progress-fill" style="width:${this.currentQIndex*10}%"></div></div>
                        <p style="font-size:0.8em; margin-bottom:10px;">Ø³ÙˆØ§Ù„ ${this.currentQIndex} Ø§Ø² Û±Û°</p>
                        <p style="direction:ltr; text-align:left; font-size:1.1em; line-height:1.5;">${item.q}</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:20px;">
                            ${item.options.map((opt, i) => `<button class="neu-btn" onclick="app.checkAns(${i})">${opt}</button>`).join('')}
                        </div>
                        <div id="fb" class="hidden feedback"></div>
                        <button id="nextBtn" class="neu-btn hidden" style="width:100%; margin-top:20px;" onclick="app.nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ â¯</button>
                        <button class="neu-btn" style="margin-top:15px; font-size:0.8em;" onclick="app.toggleHint('${item.hint}')">Ø±Ø§Ù‡Ù†Ù…Ø§ (Show Hint)</button>
                    </div>`;
            }

            checkAns(choice) {
                const item = this.currentQData;
                const fb = document.getElementById('fb');
                fb.classList.remove('hidden');
                fb.innerText = item.rationale[choice];
                const isCorrect = choice === item.correct;
                fb.style.color = isCorrect ? "green" : "red";
                if (isCorrect) this.score += 20;
                else this.mistakes.push({word: item.en, yourAns: item.options[choice], correctAns: item.options[item.correct]});
                document.getElementById('scoreDisp').innerText = this.score;
                document.querySelectorAll('#quizContainer button').forEach(b => b.onclick = null);
                document.getElementById('nextBtn').classList.remove('hidden');
            }

            toggleHint(txt) { alert("Ø±Ø§Ù‡Ù†Ù…Ø§: " + txt); }

            async finishSession() {
                this.stats.count++; this.saveStats();
                let msg = `ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Fred Practice\nğŸ‘¤ Ø´Ø§Ú¯Ø±Ø¯: ${this.studentName}\nğŸ¯ Ø§Ù…ØªÛŒØ§Ø²: ${this.score}\n`;
                if (this.mistakes.length > 0) {
                    msg += "âŒ Ø§Ø´ØªØ¨Ø§Ù‡Ø§Øª:\n";
                    this.mistakes.forEach((m, i) => msg += `${i+1}. ${m.word} (Ø²Ø¯: ${m.yourAns})\n`);
                } else msg += "â­ï¸ Ø¹Ø§Ù„ÛŒ Ùˆ Ø¨Ø¯ÙˆÙ† ØºÙ„Ø·!";
                await this.sendLog(msg);

                let reportHtml = `<h3>Ù†ØªÛŒØ¬Ù‡ ØªÙ…Ø±ÛŒÙ†</h3><p>Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: ${this.score}</p>`;
                if (this.mistakes.length > 0) {
                    this.mistakes.forEach(m => reportHtml += `<div style="font-size:0.8em; border-top:1px solid #ccc; padding:5px; direction:ltr; text-align:left;"><b>${m.word}</b>: Correct: ${m.correctAns}</div>`);
                }
                document.getElementById('quizContainer').innerHTML = `<div class="neu-card">${reportHtml}<button class="neu-btn" onclick="location.reload()" style="width:100%; margin-top:20px;">Ø¨Ø³ØªÙ† Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>`;
            }

            async sendLog(msg) {
                const url = `https://api.telegram.org/bot553224514:AAG0XXzA8da55jCGXnzStP-0IxHhnfkTPRw/sendMessage?chat_id=969918598&text=${encodeURIComponent(msg)}`;
                try { await fetch(url); } catch(e) {}
            }
        }
        const app = new DicDeepApp();
    </script>
</body>
</html>
